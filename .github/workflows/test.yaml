name: Dotfiles Install Test

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test-dotfiles:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run dotfiles installer (force mode)
        run: |
          chmod +x install.sh
          ./install.sh -y

      - name: Verify symlinks exist
        run: |
          set -e
          echo "=== Checking symlinks ==="

          # Config directory symlinks (these should always be created)
          test -L "$HOME/.config/nvim" || { echo "FAIL: ~/.config/nvim not a symlink"; exit 1; }
          test -L "$HOME/.config/zellij" || { echo "FAIL: ~/.config/zellij not a symlink"; exit 1; }
          test -L "$HOME/.config/shell" || { echo "FAIL: ~/.config/shell not a symlink"; exit 1; }
          test -L "$HOME/.claude" || { echo "FAIL: ~/.claude not a symlink"; exit 1; }

          echo "=== Symlink targets ==="
          ls -la "$HOME/.config/nvim"
          ls -la "$HOME/.config/zellij"
          ls -la "$HOME/.config/shell"
          ls -la "$HOME/.claude"

          echo "=== Verifying symlink targets are valid ==="
          test -f "$HOME/.config/nvim/init.lua" || { echo "FAIL: nvim/init.lua not accessible"; exit 1; }
          test -f "$HOME/.config/zellij/config.kdl" || { echo "FAIL: zellij/config.kdl not accessible"; exit 1; }
          test -f "$HOME/.config/shell/core.sh" || { echo "FAIL: shell/core.sh not accessible"; exit 1; }
          test -f "$HOME/.claude/CLAUDE.md" || { echo "FAIL: claude/CLAUDE.md not accessible"; exit 1; }

          echo "=== All symlinks verified successfully ==="
